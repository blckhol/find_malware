#!/bin/bash

PID_RUN=$(ps aux | grep mcs/check-file.sh)
PID_RUN=$(echo -e "$PID_RUN" | grep -v "grep" | awk '{print $2}' | sed -n 5p)
if [ "$PID_RUN" != "" ]; then
    echo "close"
    exit;
fi

echo "running script"
status="open"
while [ "$status" = "open" ]; do
    echo "finding file"
    chat_id="-1001214600022"
    token_bot="1004918957:AAGMBknRULdUQDqMOK2YBQ9bn6eA5tFMWkw"
    clue1=$(find /home -type d -name '*judi*' -ls)
    clue2=$(find /home -type d -name '*slot*' -ls)
    message=$(echo -e "$clue1\n$clue2" | awk '{for(i=1;i<7;i++) $i="";print}' | sed -e "s/      //g" | grep -v "adjudikasi" | grep -v "judicial" | grep -v "ajudikasi" | grep -v "judios" | grep -v "judische" | grep -v "checkout/slot" | grep -v "slotcontainer" | grep -v "data_judi_susila" | grep -v "internal-slot" | grep -v "moodle-mod_quiz-util-slot")
    if [ "$message" != "" ]; then
        echo "file found"
        SRV_HOSTNAME=$(hostname -f)
        SRV_IP=$(hostname -I)
        status="open"
        message=$(echo -e "[Alerting] Phising $SRV_HOSTNAME ($SRV_IP)\nMessage: Halo Gan, dicek dong ada phishing di server $SRV_HOSTNAME\n\nDirectori Location :\n$message")
        length=${#message}
        limit=3888
        if [ "$length" -gt "$limit" ]; then
            echo -e "$message" > /tmp/phishing_$SRV_HOSTNAME.txt
            message=$(echo -e "[Alerting] Phising $SRV_HOSTNAME ($SRV_IP)\nMessage: Halo Gan, dicek dong ada phishing di server $SRV_HOSTNAME")
            curl -F chat_id="$chat_id" -F document=@"/tmp/phishing_$SRV_HOSTNAME.txt" -F caption="$message" https://api.telegram.org/bot$token_bot/sendDocument
            rm -rf /tmp/phishing_$SRV_HOSTNAME.txt
        else
            curl --data-urlencode "chat_id=$chat_id" --data-urlencode "text=$message" https://api.telegram.org/bot$token_bot/sendMessage?
        fi
        sleep 360m
    else
        if [ "$status" = "open" ]; then
            echo "file is cleared"
            message=$(echo -e "[OK] Phising $SRV_HOSTNAME ($SRV_IP)\nMessage: Mantap Gan, phising di server $SRV_HOSTNAME sudah aman")
            curl --data-urlencode "chat_id=$chat_id" --data-urlencode "text=$message" https://api.telegram.org/bot$token_bot/sendMessage?
            status="close"
        else
            echo "file not found"
            status="close"
        fi
    fi

done
