#!/bin/bash

. /root/find_malware/.env 

if [ "$chat_id" = "" ] || [ "$token_bot" = "" ]; then
    exit;
fi

PID_RUN=$(ps aux | grep malware/check-file.sh)
PID_RUN=$(echo -e "$PID_RUN" | grep -v "grep" | awk '{print $2}' | sed -n 5p)
if [ "$PID_RUN" != "" ]; then
    echo "close"
    exit;
fi

echo "running script"
status="open"
while [ "$status" = "open" ]; do
    echo "finding file"
    SRV_HOSTNAME=$(hostname -f)
    SRV_IP=$(hostname -I)
    clue1=$(find /home -type d -name '*judi*' -ls)
    if [ "$clue1" != "" ]; then
        message=$(echo -e "$clue1")
    fi
    clue2=$(find /home -type d -name '*slot*' -ls)
    if [ "$clue2" != "" ]; then
        if [ "$message" = "" ]; then
            message=$(echo -e "$clue2")
        else
            message=$(echo -e "$message\n$clue2")
        fi
    fi
    clue3=$(find /home -type d -name '*casino*' -ls)
    if [ "$clue3" != "" ]; then
        if [ "$message" = "" ]; then
            message=$(echo -e "$clue3")
        else
            message=$(echo -e "$message\n$clue3")
        fi
    fi
    clue4=$(find /home -type d -name '*mahjong*' -ls)
    if [ "$clue4" != "" ]; then
        if [ "$message" = "" ]; then
            message=$(echo -e "$clue4")
        else
            message=$(echo -e "$message\n$clue4")
        fi
    fi
    clue5=$(find /home -type d -name '*toto*' -ls)
    if [ "$clue5" != "" ]; then
        if [ "$message" = "" ]; then
            message=$(echo -e "$clue5")
        else
            message=$(echo -e "$message\n$clue5")
        fi
    fi
    clue6=$(find /home -type d -name '*gacor*' -ls)
    if [ "$clue6" != "" ]; then
        if [ "$message" = "" ]; then
            message=$(echo -e "$clue6")
        else
            message=$(echo -e "$message\n$clue6")
        fi
    fi

    message=$(echo -e "$message" | sort -n | awk '{for(i=1;i<7;i++) $i="";print}' | sed -e "s/      //g" | grep -v "adjudikasi" | grep -v "judicial" | grep -v "ajudikasi" | grep -v "judios" | grep -v "judische" | grep -v "checkout/slot" | grep -v "slotcontainer" | grep -v "data_judi_susila" | grep -v "internal-slot" | grep -v "moodle-mod_quiz-util-slot" | grep -v "rtpslot" | grep -v "sloty-est" | grep -v "default-slots" | grep -v "rtpslot" | grep -v "/search/")
    if [ "$message" != "" ]; then
        status_file="found"
        status="open"

        dir_loc=$(echo "$message" | awk '{print $5}')
        while read -r line; do
            rm -rf $line
        done <<<"$dir_loc"

        message=$(echo -e "[Alerting] Phising $SRV_HOSTNAME ($SRV_IP)\nMessage: Halo Gan, dicek dong ada phishing di server $SRV_HOSTNAME\n\nDirectori Location :\n$message")
        length=${#message}
        limit=3888
        if [ "$length" -gt "$limit" ]; then
            echo -e "$message" > /tmp/phishing_$SRV_HOSTNAME.txt
            message=$(echo -e "[Alerting] Phising $SRV_HOSTNAME ($SRV_IP)\nMessage: Halo Gan, dicek dong ada phishing di server $SRV_HOSTNAME")
            curl -F chat_id="$chat_id" -F document=@"/tmp/phishing_$SRV_HOSTNAME.txt" -F caption="$message" https://api.telegram.org/bot$token_bot/sendDocument
            rm -rf /tmp/phishing_$SRV_HOSTNAME.txt
        else
            curl --data-urlencode "chat_id=$chat_id" --data-urlencode "text=$message" https://api.telegram.org/bot$token_bot/sendMessage?
        fi
        sleep 360m
    else
        if [ "$status_file" = "found" ]; then
            status_file="file is cleared"
            message=$(echo -e "[OK] Phising $SRV_HOSTNAME ($SRV_IP)\nMessage: Mantap Gan, phising di server $SRV_HOSTNAME sudah aman")
            curl --data-urlencode "chat_id=$chat_id" --data-urlencode "text=$message" https://api.telegram.org/bot$token_bot/sendMessage?
            status="close"
        else
            status_file="file not found"
            status="close"
        fi
    fi

done
